<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- æ¨™é¡Œè¨­å®š -->
    <title>æ—ç³–ç³–çš„å¥´éš¸åƒåƒå–å–ç¦å²¡è¡Œâ„ï¸</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FCA5A5">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' ry='120' fill='%23FCA5A5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' ry='120' fill='%23FCA5A5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href='data:application/manifest+json,{"name":"æ—ç³–ç³–çš„ç¦å²¡è¡Œ","short_name":"ç¦å²¡ä¹‹æ—…","display":"standalone","start_url":".","background_color":"#FFF7ED","theme_color":"#FCA5A5","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 rx=%27120%27 ry=%27120%27 fill=%27%23FCA5A5%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27central%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%27300%27 font-family=%27sans-serif%27 font-weight=%27bold%27%3Eç³–%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}'>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* æŸ”å’Œå­—é«”èˆ‡èƒŒæ™¯ */
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #FFF7ED; /* æš–ç±³è‰²èƒŒæ™¯ */
            color: #4B5563; /* æŸ”å’Œçš„æ·±ç°è‰²æ–‡å­— */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Map Styling */
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 0; border: 4px solid white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content-wrapper { border-radius: 16px; font-family: system-ui; padding: 0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 16px; }
        .leaflet-tooltip { font-weight: bold; border-radius: 8px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 12px; padding: 6px 10px; color: #4B5563; background: rgba(255, 255, 255, 0.95); }
        
        /* FIX: Ensure divIcon markers are visible */
        .custom-pin, .user-pin { display: block !important; width: 16px !important; height: 16px !important; }

        /* Animations */
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Soft Gradient Text */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #F472B6, #FB923C);
        }
    </style>
</head>
<body class="flex justify-center h-[100dvh] overflow-hidden bg-[#FFF7ED]">

    <div id="root" class="w-full h-full max-w-md bg-[#FFF7ED] shadow-2xl overflow-hidden relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
                CreditCard: <><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></>,
                Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                Navigation: <polygon points="3 11 22 2 13 21 11 13 3 11"/>,
                Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
                ShoppingBag: <><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
                Train: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><line x1="2" y1="17" x2="22" y2="17"/></>,
                Refresh: <><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                Type: <><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></>,
                Percent: <><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></>,
                Plane: <path d="M2 12h5l8 5 9-9-9-9-8 5H2v8z"/>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
                Sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                Car: <path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a1 1 0 0 0-.8.4L1.74 11l-5.16.85a1 1 0 0 0-.84.99V16h3m14 0v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2m-8 0v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-2"/>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- GLOBAL CONSTANTS ---
        const initialTripData = {
          itinerary: [
            {
              day: 1, date: "12/09 (é€±äºŒ)", theme: "åˆæŠµç¦åœ°ï¼šåšå¤šå±‹å°å¤œ",
              tasks: [
                { id: 't1-1', time: "16:55", title: "æŠµé”ç¦å²¡æ©Ÿå ´", type: "transport", lat: 33.5859, lng: 130.4507, note: "æ­ä¹˜ IT 720 æŠµé”ã€‚æº–å‚™VJWæˆªåœ–ï¼Œå¿«é€Ÿé€šé—œã€‚" },
                { id: 't1-2', time: "18:00", title: "æ­è¨ˆç¨‹è»Šå‰å¾€é£¯åº—", type: "transport", lat: 33.5892, lng: 130.4196, note: "â˜…é‡é»ï¼šå¾åœ‹éš›ç·šèˆªå»ˆ A3 å‡ºå£æ­ä¹˜ï¼Œç›´é” LIVEIL HAKATAEKIMAE (ç´„2500æ—¥åœ“)ã€‚" },
                { id: 't1-3', time: "20:00", title: "æ™šé¤ï¼šåšå¤šç¥‡åœ’éµé‹", type: "food", map: "Hakata Gion Tetsunabe", lat: 33.5908, lng: 130.4145, note: "å¿…åƒéµé‹ç…é¤ƒã€‚è‹¥æ’éšŠå¤ªé•·ï¼Œå‚™æ¡ˆï¼šTanya HAKATA (ç‰›èˆŒ)ã€‚" },
                { id: 't1-4', time: "21:30", title: "MaxValu æ¡è²·", type: "shopping", map: "MaxValu Express Hakata", lat: 33.5885, lng: 130.4180, note: "è£œçµ¦æ°´ã€æ°´æœã€æ—©é¤ã€‚é£¯åº—æ­¥è¡Œ2åˆ†é˜ã€‚" }
              ]
            },
            {
              day: 2, date: "12/10 (é€±ä¸‰)", theme: "æ–°èˆŠäº¤èï¼šé‹¼å½ˆèˆ‡é°»é­š",
              tasks: [
                { id: 't2-1', time: "08:00", title: "æ—©é¤ï¼šDacomecca", type: "food", map: "Dacomecca", lat: 33.5893, lng: 130.4215, note: "æ’éšŠååº—ï¼Œå»ºè­°å¹´è¼•äººå…ˆå»æ’ã€‚å¿…è²·ç‚­çƒ¤æ¼¢å ¡æ’éºµåŒ…ã€‚" },
                { id: 't2-2', time: "09:30", title: "æ«›ç”°ç¥ç¤¾ & å·ç«¯é€š", type: "sightseeing", map: "Kushida Shrine", lat: 33.5930, lng: 130.4105, note: "åšå¤šç¸½é®å®ˆã€‚åƒè§€åšå¤šç¥‡åœ’å±±ç¬ ã€‚" },
                { id: 't2-3', time: "10:30", title: "Full Full Hakata", type: "food", map: "Full Full Hakata", lat: 33.5940, lng: 130.4120, note: "â˜…åœ¨åœ°äººæ¨è–¦ï¼šæ‹›ç‰Œæ˜å¤ªå­æ³•åœ‹éºµåŒ…ï¼å°±åœ¨ç¥ç¤¾é™„è¿‘ã€‚" },
                { id: 't2-4', time: "12:00", title: "åˆé¤ï¼šé°»é­šå››ä»£ç›®èŠå·", type: "food", map: "Unagi Yondaime Kikukawa Fukuoka", lat: 33.5915, lng: 130.4055, note: "åŸå‰å¡šå…¬ä¼‘æ”¹æ­¤ã€‚ä¸€æœ¬é°»ååº—ï¼Œçš®é…¥è‚‰å«©ã€‚ä½æ–¼ Cross Life 1Fã€‚" },
                { id: 't2-5', time: "13:30", title: "COCO'S å¤§æ©‹åº— (å‰ä¼Šå¡å“‡)", type: "food", map: "COCO'S Ohashi", lat: 33.5600, lng: 130.4280, note: "â˜…è¯åæ´»å‹•æœè–ï¼ä½æ–¼å‰å¾€ Lalaport é€”ä¸­ (éœ€è½‰è»Šæˆ–è¨ˆç¨‹è»Š)ã€‚" },
                { id: 't2-6', time: "15:00", title: "Lalaport ç¦å²¡", type: "shopping", map: "LaLaport Fukuoka", lat: 33.5645, lng: 130.4410, note: "æœè– 1:1 é‹¼å½ˆç«‹åƒ (æ•´é»æœ‰æ¼”å‡º)ã€‚" },
                { id: 't2-7', time: "17:30", title: "æ™šé¤ï¼šç‡’è‚‰å¤§æ±åœ’", type: "food", map: "Daitoen Honten", lat: 33.5928, lng: 130.4118, note: "éœ€é ç´„ã€‚å‚™æ¡ˆï¼šåšå¤šè¯å‘³é³¥ã€‚" },
                { id: 't2-8', time: "20:30", title: "åšå¤šé‹æ²³åŸæ°´èˆ", type: "sightseeing", map: "Canal City Hakata", lat: 33.5898, lng: 130.4108, note: "æ¬£è³å¤œé–“æ°´èˆç§€ã€‚" }
              ]
            },
            {
              day: 3, date: "12/11 (é€±å››)", theme: "å¤ªå®°åºœæ¥“ç´… & å¤©ç¥",
              tasks: [
                { id: 't3-1', time: "10:00", title: "æ­ä¹˜ã€Œæ—…äººã€è™Ÿ", type: "transport", note: "åšå¤šå·´å£«ç¸½ç«™1F 11è™Ÿæœˆå°ï¼Œç›´é”å¤ªå®°åºœã€‚" },
                { id: 't3-2', time: "11:00", title: "å¤ªå®°åºœå¤©æ»¿å®®", type: "sightseeing", map: "Dazaifu Tenmangu", lat: 33.5215, lng: 130.5349, note: "åƒæ‹œé£›æ¢…é¤¨ã€‚è¡¨åƒé“åƒæ¢…æé¤…ã€‚æ˜Ÿå·´å…‹æ¦‚å¿µåº—ã€‚" },
                { id: 't3-3', time: "13:00", title: "åˆé¤ï¼šä¸€è˜­æ‹‰éºµ", type: "food", map: "Ichiran Dazaifu", lat: 33.5195, lng: 130.5335, note: "å¤ªå®°åºœé™å®šäº”è§’ç¢— (åˆæ ¼æ‹‰éºµ)ã€‚" },
                { id: 't3-extra', time: "14:00", title: "ç«ˆé–€ç¥ç¤¾ (è³æ¥“)", type: "sightseeing", map: "Kamado Shrine", lat: 33.5325, lng: 130.5480, note: "æ­ä¹˜ç¤¾å€å·´å£«ã€ŒMahorobaã€å‰å¾€ï¼Œçµ•ç¾è³æ¥“åæ‰€ã€‚" },
                { id: 't3-4', time: "16:00", title: "è¿”å›å¤©ç¥ & Pain Stock", type: "shopping", map: "Pain Stock Tenjin", lat: 33.5900, lng: 130.4020, note: "éºµåŒ…æ®¿å ‚ã€‚å¤©ç¥ä¸­å¤®å…¬åœ’æ•£æ­¥ã€‚" },
                { id: 't3-5', time: "19:00", title: "æ™šé¤ï¼šéºµå±‹å…¼è™/å¤§ç ²", type: "food", map: "Menya Kanetora", lat: 33.5880, lng: 130.4005, note: "å¹´è¼•çµ„åƒæ¿ƒåšæ²¾éºµï¼Œå®¶åº­çµ„å¯é¸ç™¾è²¨é¤å»³ã€‚" }
              ]
            },
            {
              day: 4, date: "12/12 (é€±äº”)", theme: "æ¸¯éƒ½æ‡·èˆŠï¼šé–€å¸æ¸¯",
              tasks: [
                { id: 't4-1', time: "09:00", title: "ç§»å‹•ï¼šåšå¤š -> é–€å¸æ¸¯", type: "transport", note: "å»ºè­°æ­æ–°å¹¹ç·šè‡³å°å€‰è½‰JRï¼Œç¯€çœé«”åŠ›ã€‚" },
                { id: 't4-2', time: "10:30", title: "é–€å¸æ¸¯æ‡·èˆŠå€", type: "sightseeing", map: "Mojiko Retro", lat: 33.9450, lng: 130.9610, note: "èˆŠä¸‰äº•ä¿±æ¨‚éƒ¨ã€è—ç¿¼é–€å¸åŠæ©‹ã€‚" },
                { id: 't4-3', time: "12:30", title: "åˆé¤ï¼šä¼½å“©æœ¬èˆ—", type: "food", map: "Curry Honpo Mojiko", lat: 33.9460, lng: 130.9620, note: "ç‡’å’–å“©ååº—ï¼Œæ¨è–¦é çª—åº§ä½ã€‚" },
                { id: 't4-4', time: "13:30", title: "ä¸‹åˆèŒ¶ï¼šMILKHALL MOJIKO", type: "food", map: "MILKHALL MOJIKO", lat: 33.9455, lng: 130.9615, note: "äº«ç”¨é–€å¸æ¸¯å¿…åƒå¸ƒä¸ï¼ä¼‘æ¯ç‰‡åˆ»ã€‚" },
                { id: 't4-5', time: "15:00", title: "å”æˆ¶å¸‚å ´ (é¸ä¿®)", type: "sightseeing", map: "Karato Market", lat: 33.9575, lng: 130.9415, note: "æ­è¯çµ¡èˆ¹å‰å¾€ï¼Œé«”é©—æµ·åº•éš§é“ã€‚" },
                { id: 't4-6', time: "18:00", title: "æ™šé¤ï¼šä½†é¦¬å±‹/å°æ—é¤Šé›", type: "food", map: "Tajimaya KITTE Hakata", lat: 33.5895, lng: 130.4205, note: "å›åšå¤šç”¨é¤ã€‚å£½å–œç‡’åƒåˆ°é£½æˆ–å±…é…’å±‹ã€‚" }
              ]
            },
            {
              day: 5, date: "12/13 (é€±å…­)", theme: "åšå¤šç¾é£Ÿç²¾é«“",
              tasks: [
                { id: 't5-1', time: "08:30", title: "æ—©é¤ï¼šé£Ÿå ‚ ãŠã‚ã‚“", type: "food", map: "Shokudo Owan", lat: 33.5910, lng: 130.4150, note: "ç²¾ç·»æ—¥å¼å‚³çµ±æœé£Ÿã€‚" },
                { id: 't5-2', time: "10:00", title: "å¤©ç¥åœ°ä¸‹è¡—", type: "shopping", map: "Tenjin Chikagai", lat: 33.5905, lng: 130.4000, note: "è³¼ç‰©æƒè²¨ã€‚" },
                { id: 't5-3', time: "12:00", title: "åˆé¤ï¼šTonkatsu Wakaba", type: "food", map: "Tonkatsu Wakaba", lat: 33.5935, lng: 130.4025, note: "ç‚¸è±¬æ’ç¥åº—ã€‚å‹™å¿…11:15å‰æ’éšŠã€‚" },
                { id: 't5-4', time: "15:00", title: "åšå¤šé‹æ²³åŸ", type: "shopping", map: "Canal City", note: "è£œå®Œè³¼ç‰©è¡Œç¨‹ï¼Œçœ‹å™´æ°´ç§€ã€‚" },
                { id: 't5-5', time: "17:30", title: "æ™šé¤ï¼šè¯å‘³é³¥ / å‰ç”°å±‹", type: "food", map: "Hanamidori", lat: 33.5920, lng: 130.4100, note: "åˆ†çµ„è¡Œå‹•ï¼šé•·è¼©åƒæ°´ç‚Šé›ï¼Œå¹´è¼•äººåƒç‰›è…¸é‹ã€‚éœ€é ç´„ã€‚" }
              ]
            },
            {
              day: 6, date: "12/14 (é€±æ—¥)", theme: "ç¦å²¡ç”Ÿæ´»å…‰è­œ",
              tasks: [
                { id: 't6-1', time: "09:00", title: "å…­æœ¬æ¾éºµåŒ…å·¡ç¦®", type: "food", map: "Amam Dacotan", lat: 33.5785, lng: 130.3755, note: "Amam Dacotan è©±é¡Œåº—ã€‚è‹¥æ’å¤ªé•·æ”¹å» Matsu Panã€‚" },
                { id: 't6-2', time: "10:30", title: "å¤§æ¿ å…¬åœ’ & ç¾è¡“é¤¨", type: "sightseeing", map: "Ohori Park", lat: 33.5865, lng: 130.3763, note: "æ¹–ç•”é‡é¤ï¼Œè‰é–“å½Œç”Ÿå—ç“œã€‚" },
                { id: 't6-3', time: "14:00", title: "åˆé¤ï¼šé­šå¿ ", type: "food", map: "Uochu", lat: 33.5840, lng: 130.3980, note: "é«˜ç´šé®®é­šåº—ç›´ç‡Ÿï¼Œé«˜CPå€¼å®šé£Ÿã€‚" },
                { id: 't6-4', time: "15:00", title: "è—¥é™¢é›œè²¨æ•£ç­–", type: "shopping", map: "BBB POTTERS", lat: 33.5790, lng: 130.3950, note: "BBB POTTERS & Coffee Countyã€‚" },
                { id: 't6-5', time: "17:00", title: "ç¦å²¡å¡”å¤œæ™¯", type: "sightseeing", map: "Fukuoka Tower", lat: 33.5932, lng: 130.3515, note: "ç™¾é“æµ·æ¿±ï¼Œèœ‚æ¨‚é¥…é ­ã€‚" },
                { id: 't6-6', time: "19:00", title: "æ™šé¤ï¼šå°æ—é¤Šé›(è¥¿æ–°åº—)", type: "food", map: "Kobayashi Youkei Nishijin", lat: 33.5825, lng: 130.3580, note: "åœ¨åœ°äººå–œæ„›çš„å±…é…’å±‹ï¼Œæ°£æ°›ç†±é¬§ã€‚" }
              ]
            },
            {
              day: 7, date: "12/15 (é€±ä¸€)", theme: "å®Œç¾æ­¸é€”",
              tasks: [
                { id: 't7-1', time: "09:00", title: "Check-out & å¯„æ”¾", type: "transport", note: "è¡Œæå¯„æ”¾é£¯åº—æ«ƒæª¯ã€‚" },
                { id: 't7-2', time: "11:00", title: "åšå¤šç«™æœ€å¾Œè¡åˆº", type: "shopping", map: "Hakata Hankyu", lat: 33.5895, lng: 130.4205, note: "åšå¤šé˜ªæ€¥B1ä¼´æ‰‹ç¦® (åŠªåŠªé›ã€ç¦ç ‚å±‹)ã€‚" },
                { id: 't7-3', time: "12:30", title: "åˆé¤ï¼šåšå¤šéºµè¡—é“", type: "food", map: "Hakata Deitos", lat: 33.5900, lng: 130.4210, note: "Shin-Shin æˆ– æµ·é³´æ‹‰éºµã€‚" },
                { id: 't7-4', time: "14:00", title: "å‰å¾€æ©Ÿå ´", type: "transport", map: "Fukuoka Airport", lat: 33.5859, lng: 130.4507, note: "è¨ˆç¨‹è»Šç›´é”åœ‹éš›ç·šã€‚å‹™å¿…ææ—©æŠµé”ã€‚" },
                { id: 't7-5', time: "17:55", title: "é£›æ©Ÿèµ·é£› (IT 721)", type: "transport", note: "å¸¶è‘—æ»¿æ»¿å›æ†¶å›å®¶ï¼" }
              ]
            }
          ]
        };

        const initialChecklist = [
          { id: 'c1', text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', done: false, cat: 'document' },
          { id: 'c2', text: 'Visit Japan Web æˆªåœ–', done: false, cat: 'document' },
          { id: 'c3', text: 'æ—¥å¹£ç¾é‡‘ & ä¿¡ç”¨å¡ (å‰é¶´å¡)', done: false, cat: 'money' },
          { id: 'c4', text: 'ç¶²å¡ / æ¼«éŠè¨­å®š', done: false, cat: 'other' },
          { id: 'c5', text: 'è¡Œå‹•é›»æº & å……é›»ç·š', done: false, cat: 'other' },
          { id: 'c6', text: 'å€‹äººè—¥å“ (èƒƒè—¥/æ­¢ç—›è—¥)', done: false, cat: 'other' },
          { id: 'c7', text: 'ä¿æš–è¡£ç‰© (åœå·¾/æ‰‹å¥—)', done: false, cat: 'other' },
          { id: 'c8', text: 'è³¼ç‰©è¢‹ (å¤§)', done: false, cat: 'other' },
          { id: 'c9', text: 'ç‰™åˆ·ç‰™è† (éƒ¨åˆ†é£¯åº—ä¸æä¾›)', done: false, cat: 'other' }
        ];

        // --- COMPONENTS ---

        const MapTab = ({ itinerary }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const markersGroupRef = useRef(null);
            const [userMarkers, setUserMarkers] = useState(() => JSON.parse(localStorage.getItem('fukuoka_user_markers')) || []);
            const [isAdding, setIsAdding] = useState(false);
            const [newMarkerPos, setNewMarkerPos] = useState(null);
            const [newMarkerName, setNewMarkerName] = useState('');
            const [newMarkerType, setNewMarkerType] = useState('food');

            useEffect(() => { localStorage.setItem('fukuoka_user_markers', JSON.stringify(userMarkers)); }, [userMarkers]);

            useEffect(() => {
                window.fukuokaDeleteMarker = (id) => {
                    if(window.confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) {
                        setUserMarkers(prev => prev.filter(m => m.id !== id));
                    }
                };
                return () => { delete window.fukuokaDeleteMarker; };
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current && mapContainerRef.current) {
                    mapInstanceRef.current = L.map(mapContainerRef.current).setView([33.5902, 130.4207], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);

                    mapInstanceRef.current.on('click', (e) => {
                        setNewMarkerPos(e.latlng);
                        setIsAdding(true);
                    });
                    
                    markersGroupRef.current = L.layerGroup().addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;
                const markersLayer = markersGroupRef.current;

                if (markersLayer) markersLayer.clearLayers();

                const addMarkerToMap = (lat, lng, title, type, isUser = false, id = null) => {
                    let color = '#22C55E'; // Green
                    if (type === 'food') color = '#F97316'; // Orange
                    if (type === 'sightseeing') color = '#3B82F6'; // Blue
                    if (type === 'shopping') color = '#EC4899'; // Pink
                    
                    const borderStyle = isUser ? 'border: 2px dashed white;' : 'border: 2px solid white;';
                    const markerHtml = `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; ${borderStyle} box-shadow: 0 3px 6px rgba(0,0,0,0.3);"></div>`;
                    
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: markerHtml,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -10],
                        tooltipAnchor: [8, -4] 
                    });
                    
                    const marker = L.marker([lat, lng], { icon }).addTo(markersLayer);
                    
                    marker.bindTooltip(title, { 
                        permanent: false, 
                        direction: 'top',
                        offset: [0, -12],
                        opacity: 0.9
                    });

                    const googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`;
                    
                    let popupContent = `
                        <div style="text-align:center; min-width: 120px;">
                            <div style="font-weight:bold; color:#4B5563; margin-bottom:8px; font-size:14px;">${title}</div>
                            <a href="${googleMapLink}" target="_blank" style="background-color:#60A5FA; color:white; padding:6px 16px; border-radius:99px; text-decoration:none; font-size:12px; font-weight:bold; display:inline-block; box-shadow: 0 2px 5px rgba(96,165,250,0.4);">å°èˆª GO ></a>
                    `;

                    if (isUser) {
                        popupContent += `<div style="margin-top:12px; border-top:1px solid #F3F4F6; padding-top:8px;"><button onclick="window.fukuokaDeleteMarker(${id})" style="color:#F87171; font-size:12px; border:none; background:none; text-decoration:underline; cursor:pointer; font-weight:bold;">åˆªé™¤æ­¤æ¨™è¨˜</button></div>`;
                    }
                    
                    popupContent += `</div>`;
                    marker.bindPopup(popupContent);
                };

                itinerary.forEach(day => {
                    day.tasks.forEach(task => {
                        if (task.lat && task.lng) {
                            addMarkerToMap(task.lat, task.lng, task.title, task.type);
                        }
                    });
                });

                userMarkers.forEach(m => {
                    addMarkerToMap(m.lat, m.lng, m.title, m.type, true, m.id);
                });

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if (map) {
                                if (!userMarkerRef.current) {
                                    const userIcon = L.divIcon({
                                        className: 'user-pin',
                                        html: "<div style='background-color:#3B82F6; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow: 0 0 0 6px rgba(59,130,246,0.3);'></div>",
                                        iconSize: [28, 28],
                                        iconAnchor: [14, 14]
                                    });
                                    userMarkerRef.current = L.marker([latitude, longitude], {icon: userIcon, zIndexOffset: 1000}).addTo(map);
                                } else {
                                    userMarkerRef.current.setLatLng([latitude, longitude]);
                                }
                            }
                        },
                        (error) => { console.log("GPS Error", error); },
                        { enableHighAccuracy: true }
                    );
                }
            }, [itinerary, userMarkers]); 

            const confirmAddMarker = () => {
                if (!newMarkerName || !newMarkerPos) return;
                const newMarker = {
                    id: Date.now(),
                    lat: newMarkerPos.lat,
                    lng: newMarkerPos.lng,
                    title: newMarkerName,
                    type: newMarkerType
                };
                setUserMarkers([...userMarkers, newMarker]);
                setIsAdding(false);
                setNewMarkerName('');
            };

            return (
                <div className="h-full flex flex-col bg-[#FFF7ED] relative">
                    {/* Instructions Overlay */}
                    <div className="absolute top-4 left-4 right-4 z-[400] bg-white/90 backdrop-blur-md px-4 py-3 rounded-2xl shadow-lg border border-orange-100 flex justify-between items-center">
                        <span className="text-xs font-bold text-slate-600">ğŸ‘† é»æ“Šåœ°åœ–ï¼šæ–°å¢æ¨™è¨˜</span>
                        <div className="flex gap-2 text-[10px] font-bold text-slate-500">
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-400"></span>é£Ÿ</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400"></span>ç©</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-400"></span>è³¼</span>
                        </div>
                    </div>
                    
                    {isAdding && (
                        <div className="absolute inset-0 z-[500] bg-black/20 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-xs animate-bounce-in">
                                <h3 className="font-bold text-slate-800 mb-1 text-lg">ğŸ“ æ–°å¢åœ°é»</h3>
                                <p className="text-xs text-slate-400 mb-4">åº§æ¨™: {newMarkerPos.lat.toFixed(4)}, {newMarkerPos.lng.toFixed(4)}</p>
                                <div className="border-t border-slate-100 pt-4">
                                    <label className="text-xs font-bold text-slate-400 block mb-2">åç¨±ï¼š</label>
                                    <input 
                                        placeholder="ä¾‹å¦‚ï¼šå¥½åƒçš„æ‹‰éºµ" 
                                        className="w-full p-3 mb-4 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        value={newMarkerName}
                                        onChange={e => setNewMarkerName(e.target.value)}
                                        autoFocus
                                    />
                                    <div className="flex gap-2 mb-4">
                                        {['food', 'sightseeing', 'shopping'].map(t => (
                                            <button 
                                                key={t}
                                                onClick={() => setNewMarkerType(t)}
                                                className={`flex-1 py-2 rounded-xl text-xs font-bold capitalize border-2 transition ${newMarkerType === t ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-100'}`}
                                            >
                                                {t === 'food' ? 'é£Ÿ' : t === 'sightseeing' ? 'ç©' : 'è³¼'}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl text-sm font-bold">å–æ¶ˆ</button>
                                        <button onClick={confirmAddMarker} className="flex-1 py-3 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-blue-200">æ–°å¢</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div id="map" ref={mapContainerRef} className="flex-1 w-full h-full z-0"></div>
                </div>
            );
        };

        const HomeTab = ({ leaderInfo, setLeaderInfo, setActiveTab, apiKey, setApiKey }) => {
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [appTitle, setAppTitle] = useState(() => localStorage.getItem('fukuoka_app_title') || "æ—ç³–ç³–çš„å¥´éš¸åƒåƒå–å–ç¦å²¡è¡Œâ„ï¸");
            const [isEditingLeader, setIsEditingLeader] = useState(false);
            const [tempLeader, setTempLeader] = useState(leaderInfo);
            const [tempKey, setTempKey] = useState(apiKey);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(false);

            useEffect(() => { setTempLeader(leaderInfo); }, [leaderInfo]);

            // Update to 2025/12/09
            const now = new Date();
            const targetDate = new Date("2025-12-09T10:00:00+09:00");
            const diff = targetDate ? targetDate - now : 0;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            const saveTitle = () => { localStorage.setItem('fukuoka_app_title', appTitle); setIsEditingTitle(false); };
            const saveLeader = () => {
                setLeaderInfo(tempLeader);
                setApiKey(tempKey);
                setIsEditingLeader(false);
            };

            const fetchWeather = () => {
                setLoadingWeather(true);
                
                if (!("geolocation" in navigator)) {
                    alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                    setLoadingWeather(false);
                    return;
                }

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                        const data = await response.json();
                        setWeather({
                            temperature: data.current_weather.temperature,
                            windspeed: data.current_weather.windspeed
                        });
                    } catch (error) {
                        console.error("Weather fetch failed", error);
                        alert("å¤©æ°£è³‡è¨Šç²å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                    } finally {
                        setLoadingWeather(false);
                    }
                }, (error) => {
                    console.error("Geolocation error", error);
                    alert("ç„¡æ³•ç²å–ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªæ‚¨å·²æˆæ¬Šå®šä½åŠŸèƒ½ã€‚");
                    setLoadingWeather(false);
                });
            };

            return (
                <div className="h-full overflow-y-auto pb-28 bg-[#FFF7ED]">
                    <div className="bg-gradient-to-br from-indigo-300 to-purple-300 text-white p-8 pb-12 rounded-b-[3rem] shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-[60px] -mr-16 -mt-16"></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start">
                                <div className="inline-block px-4 py-1.5 bg-white/20 backdrop-blur-md rounded-full text-white text-xs font-bold mb-4 border border-white/30 shadow-sm">2025.12.09 å‡ºç™¼</div>
                                <button onClick={() => setIsEditingTitle(!isEditingTitle)} className="text-white/70 hover:text-white bg-white/10 p-2 rounded-full"><Icon name="Edit" size={16}/></button>
                            </div>
                            {isEditingTitle ? (
                                <div className="flex gap-2">
                                    <input value={appTitle} onChange={(e) => setAppTitle(e.target.value)} className="text-slate-800 text-lg p-3 rounded-xl flex-1 shadow-lg outline-none"/>
                                    <button onClick={saveTitle} className="bg-white text-indigo-600 px-4 rounded-xl text-sm font-bold shadow-lg">å„²å­˜</button>
                                </div>
                            ) : (
                                <h1 className="text-2xl font-black mb-2 tracking-tight leading-tight drop-shadow-sm">{appTitle}</h1>
                            )}
                            <p className="text-white/80 text-sm font-medium">å¥´éš¸å®ˆå‰‡ #1ï¼šç³–ç³–é¤“äº†è¦é¦¬ä¸Šæ‹¿å‡ºé£Ÿç‰©ã€‚</p>
                        </div>
                    </div>

                    <div className="p-5 space-y-5 -mt-10 relative z-20">
                        {/* å€’æ•¸å¡ç‰‡ */}
                        <div className="bg-white p-5 rounded-3xl shadow-lg shadow-blue-100/50 border border-white relative overflow-hidden group hover:shadow-xl transition">
                            <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-[3rem] -mr-6 -mt-6 z-0"></div>
                            <div className="relative z-10">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2.5 bg-blue-100 text-blue-600 rounded-xl shadow-sm"><Icon name="Plane" size={20}/></div> 
                                    <div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">è·é›¢å‡ºç™¼</div><div className="font-black text-slate-800 text-lg">ç¦å²¡ä¹‹æ—…</div></div>
                                </div>
                                <div className="flex justify-between items-end">
                                    <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 font-mono tracking-tighter">{days > 0 ? days : 0}<span className="text-sm text-slate-400 font-sans font-bold ml-1 mr-3">å¤©</span></div>
                                    <div className="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded-lg">æº–å‚™å¥½è­·ç…§äº†å—ï¼Ÿ</div>
                                </div>
                            </div>
                        </div>

                        {/* é ˜éšŠè¨­å®š */}
                        <div className="bg-white p-5 rounded-3xl shadow-lg shadow-indigo-100/50 border border-white">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="User" size={18} className="text-indigo-400"/> é ˜éšŠ & AI è¨­å®š</h3>
                                <button onClick={() => isEditingLeader ? saveLeader() : setIsEditingLeader(true)} className="text-xs font-bold text-indigo-500 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100 transition">{isEditingLeader ? 'å„²å­˜' : 'ç·¨è¼¯'}</button>
                            </div>
                            {isEditingLeader ? (
                                <div className="space-y-3">
                                    <input placeholder="é ˜éšŠå§“å" value={tempLeader.name} onChange={(e) => setTempLeader({...tempLeader, name: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm"/>
                                    <input placeholder="æ‰‹æ©Ÿ" value={tempLeader.phone} onChange={(e) => setTempLeader({...tempLeader, phone: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm"/>
                                    <div className="pt-3 border-t border-slate-50 mt-2">
                                        <label className="text-xs text-slate-400 block mb-2 font-bold">Google Gemini API Key (AIè¨˜å¸³ç”¨):</label>
                                        <input 
                                            type="password" 
                                            placeholder="è²¼ä¸Š API Key" 
                                            value={tempKey} 
                                            onChange={(e) => setTempKey(e.target.value)}
                                            className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm font-mono"
                                        />
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-indigo-400 shadow-sm">
                                            {leaderInfo.name ? <span className="text-xl font-black">{leaderInfo.name[0]}</span> : <Icon name="User" size={24}/>}
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800 text-lg">{leaderInfo.name || "æœªè¨­å®šé ˜éšŠ"}</div>
                                            <div className="text-sm text-slate-400">{leaderInfo.phone || "å°šç„¡é›»è©±"}</div>
                                        </div>
                                    </div>
                                    {apiKey && (
                                        <div className="flex items-center gap-2 bg-green-50 p-3 rounded-xl text-xs font-bold text-green-600 border border-green-100">
                                            <Icon name="CheckSquare" size={14}/> AI ç›¸æ©Ÿè¨˜å¸³åŠŸèƒ½å·²å°±ç·’
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* å¤©æ°£ */}
                        <div className="bg-white p-5 rounded-3xl shadow-lg shadow-orange-100/50 border border-white flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-2"><Icon name="Sun" size={18} className="text-orange-400"/> æ‰€åœ¨åœ°å¤©æ°£ (å³æ™‚)</h3>
                                {weather ? <div className="text-3xl font-black text-slate-800">{weather.temperature}Â°C</div> : <button onClick={fetchWeather} className="text-xs bg-orange-50 text-orange-600 px-4 py-2 rounded-xl font-bold mt-1 hover:bg-orange-100 transition">{loadingWeather ? "å®šä½ä¸­..." : "é»æ“Šç²å–æ°£æº«"}</button>}
                            </div>
                            {weather && <div className="text-right"><div className="text-xs text-slate-400 font-medium mb-1">é¢¨é€Ÿ: {weather.windspeed} km/h</div><div className="text-xs text-blue-500 font-bold bg-blue-50 px-3 py-1 rounded-lg">å³æ™‚åµæ¸¬</div></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ToolboxTab = ({ checklist, setChecklist, toggleChecklist }) => {
            const [jpy, setJpy] = useState('');
            const [rate, setRate] = useState(0.22);
            const [isAddressBig, setIsAddressBig] = useState(false);
            const [price, setPrice] = useState('');
            const [discount, setDiscount] = useState(10); // tax free
            const [newItemText, setNewItemText] = useState('');
            
            const links = [
                { name: "Google Maps", url: "https://www.google.com/maps", icon: "MapPin", color: "text-red-500", bg: "bg-red-50" },
                { name: "Tabelog (ç¾é£Ÿ)", url: "https://tabelog.com/", icon: "Utensils", color: "text-orange-500", bg: "bg-orange-50" },
                { name: "Yahoo! ä¹˜æ›", url: "https://transit.yahoo.co.jp/", icon: "Train", color: "text-green-600", bg: "bg-green-50" },
                { name: "Rokemusa (æŸ¥åº—)", url: "https://www.locationsmart.org/", icon: "MapPin", color: "text-purple-500", bg: "bg-purple-50" },
                { name: "è¡Œç¨‹åƒè€ƒç¶²é ", url: "https://82115linjerry.github.io/fukuoka-trip6night/", icon: "ExternalLink", color: "text-indigo-500", bg: "bg-indigo-50" }
            ];

            const addChecklistItem = () => {
                if(!newItemText.trim()) return;
                const newItem = { id: Date.now().toString(), text: newItemText, done: false, cat: 'other' };
                setChecklist(prev => [...prev, newItem]);
                setNewItemText('');
            };

            const deleteChecklistItem = (id, e) => {
                e.stopPropagation();
                if(window.confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) {
                    setChecklist(prev => prev.filter(item => item.id !== id));
                }
            };

            return (
                <div className="h-full overflow-y-auto p-5 space-y-5 pb-32 bg-[#FFF7ED]">
                    
                    {/* è¡Œå‰æº–å‚™æ¸…å–® (æ•´åˆè‡³æ­¤) */}
                    <div className="bg-white rounded-3xl shadow-lg shadow-indigo-100/50 border border-white overflow-hidden">
                        <div className="bg-indigo-600 p-4 flex justify-between items-center text-white">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="CheckSquare" size={20}/> è¡Œå‰æº–å‚™æ¸…å–®</h3>
                            <span className="text-xs bg-indigo-500 px-2 py-1 rounded">{checklist.filter(i=>i.done).length}/{checklist.length}</span>
                        </div>
                        
                        <div className="p-3 bg-indigo-50 flex gap-2">
                            <input 
                                value={newItemText}
                                onChange={(e) => setNewItemText(e.target.value)}
                                placeholder="æ–°å¢é …ç›®..."
                                className="flex-1 p-2 rounded-xl text-sm border-none outline-none text-slate-700"
                            />
                            <button onClick={addChecklistItem} className="bg-indigo-600 text-white p-2 rounded-xl"><Icon name="Plus" size={18}/></button>
                        </div>

                        <div className="divide-y divide-slate-100 max-h-60 overflow-y-auto">
                            {checklist.map(item => (
                                <div key={item.id} onClick={() => toggleChecklist(item.id)} className="p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-50 group">
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${item.done ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>
                                        {item.done && <Icon name="Check" size={14} className="text-white"/>}
                                    </div>
                                    <span className={`text-sm font-bold flex-1 ${item.done ? 'text-slate-400 line-through' : 'text-slate-700'}`}>{item.text}</span>
                                    <button onClick={(e) => deleteChecklistItem(item.id, e)} className="text-slate-300 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="Trash2" size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* å¸¸ç”¨é€£çµ */}
                    <div className="grid grid-cols-2 gap-3">
                        {links.map((link, i) => (
                            <a key={i} href={link.url} target="_blank" className="bg-white p-3 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center gap-2 hover:bg-white/80 transition no-underline text-center">
                                <div className={`p-2 rounded-xl ${link.bg} ${link.color}`}><Icon name={link.icon} size={18}/></div>
                                <span className="font-bold text-slate-700 text-xs">{link.name}</span>
                            </a>
                        ))}
                    </div>

                    {/* é‹å°‡å¡ */}
                    <div className="bg-white rounded-3xl shadow-lg shadow-indigo-100/50 border border-white overflow-hidden">
                        <div className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Car" size={18}/> é‹å°‡å¡ (çµ¦å¸æ©Ÿçœ‹)</h3>
                            <button onClick={() => setIsAddressBig(!isAddressBig)} className="text-xs bg-white/20 px-3 py-1.5 rounded-lg font-bold">{isAddressBig ? "ç¸®å°" : "æ”¾å¤§"}</button>
                        </div>
                        <div className={`p-6 flex flex-col justify-center items-center text-center transition-all duration-300 ${isAddressBig ? "fixed inset-0 z-[999] bg-white justify-center h-screen p-10" : ""}`}>
                            {isAddressBig && <button onClick={() => setIsAddressBig(false)} className="absolute top-6 right-6 bg-slate-100 p-3 rounded-full"><Icon name="ChevronDown" size={28}/></button>}
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-3">è«‹è¼‰æˆ‘å»é€™è£¡</p>
                            <h2 className={`font-black text-slate-800 leading-tight mb-4 ${isAddressBig ? "text-4xl" : "text-xl"}`}>LIVEIL<br/>HAKATAEKIMAE</h2>
                            <p className={`font-bold text-slate-600 bg-slate-50 p-4 rounded-2xl w-full ${isAddressBig ? "text-xl" : "text-sm"}`}>ã€’812-0011<br/>ç¦å²¡å¸‚åšå¤šåŒº<br/>åšå¤šé§…å‰4ä¸ç›®31-11</p>
                        </div>
                    </div>

                    {/* åŒ¯ç‡è¨ˆç®— */}
                    <div className="bg-white rounded-3xl shadow-lg shadow-green-100/50 border border-white p-5">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-4"><Icon name="DollarSign" size={18} className="text-green-500"/> ç°¡æ˜“åŒ¯ç‡</h3>
                        <div className="flex gap-3 items-center">
                            <input type="number" value={jpy} onChange={(e) => setJpy(e.target.value)} placeholder="æ—¥å¹£" className="w-full text-xl font-bold p-3 bg-slate-50 rounded-xl border-none outline-none text-slate-800"/>
                            <Icon name="Refresh" size={20} className="text-slate-300"/>
                            <div className="w-full text-xl font-bold p-3 text-slate-800 bg-slate-50 rounded-xl text-center">NT$ {jpy ? Math.round(jpy * rate).toLocaleString() : "0"}</div>
                        </div>
                    </div>

                    {/* æŠ˜æ‰£è¨ˆç®— */}
                    <div className="bg-white rounded-3xl shadow-lg shadow-pink-100/50 border border-white p-5">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-4"><Icon name="Percent" size={18} className="text-pink-500"/> å…ç¨…è¨ˆç®—</h3>
                        <div className="grid grid-cols-2 gap-3 mb-4">
                            <div><label className="text-[10px] text-slate-400 font-bold ml-1">é‡‘é¡</label><input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="Â¥" className="w-full p-2 bg-slate-50 rounded-xl font-bold text-slate-800"/></div>
                            <div><label className="text-[10px] text-slate-400 font-bold ml-1">æŠ˜æ‰£%</label><input type="number" value={discount} onChange={e => setDiscount(e.target.value)} className="w-full p-2 bg-slate-50 rounded-xl font-bold text-slate-800"/></div>
                        </div>
                        <div className="bg-slate-800 text-white p-3 rounded-xl flex justify-between items-center shadow-lg">
                            <span className="text-xs opacity-60 font-bold">æŠ˜åˆå°å¹£</span>
                            <span className="text-2xl font-black">NT$ {price ? Math.round(price * (1 - discount/100) * rate).toLocaleString() : 0}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseTracker = ({ apiKey }) => {
            const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem('fukuoka_expenses')) || []);
            const [newItem, setNewItem] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newCat, setNewCat] = useState('food');
            const [isScanning, setIsScanning] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('fukuoka_expenses', JSON.stringify(expenses)); }, [expenses]);

            const addExpense = () => {
                if (!newItem || !newAmount) return;
                setExpenses([{ id: Date.now(), item: newItem, amount: parseInt(newAmount), cat: newCat }, ...expenses]);
                setNewItem('');
                setNewAmount('');
            };

            const triggerCamera = () => {
                if (fileInputRef.current) fileInputRef.current.click();
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!apiKey) {
                    alert("è«‹å…ˆè‡³é¦–é è¨­å®š API Keyï¼");
                    return;
                }

                setIsScanning(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1];
                    try {
                        // Simulated API call for UI demonstration if no key, but logic is ready for real key
                        // In real scenario, this fetches from Gemini
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: "Analyze this receipt. Return JSON: {item: string, amount: number, cat: 'food'|'transport'|'shopping'|'other'}" },
                                        { inline_data: { mime_type: file.type, data: base64Data } }
                                    ]
                                }]
                            })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        // Parse logic (simplified for demo)
                        const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                        const result = JSON.parse(text);
                        setNewItem(result.item);
                        setNewAmount(result.amount);
                        setNewCat(result.cat);
                        alert("æƒææˆåŠŸï¼è«‹ç¢ºèªå¾Œæ–°å¢ã€‚");
                    } catch (error) {
                        console.error(error);
                        alert("æƒæå¤±æ•—æˆ– API Key ç„¡æ•ˆï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
                    } finally {
                        setIsScanning(false);
                        if (fileInputRef.current) fileInputRef.current.value = '';
                    }
                };
            };

            const total = expenses.reduce((sum, ex) => sum + ex.amount, 0);

            return (
                <div className="p-5 space-y-5 bg-[#FFF7ED] h-full overflow-y-auto pb-32">
                    <div className="bg-slate-900 p-6 rounded-3xl shadow-xl shadow-slate-300 relative overflow-hidden text-white">
                        <div className="relative z-10">
                            <div className="text-white/60 text-sm font-bold tracking-widest mb-1 uppercase">ç›®å‰ç¸½èŠ±è²»</div>
                            <div className="text-5xl font-black tracking-tighter">Â¥ {total.toLocaleString()}</div>
                        </div>
                        <button 
                            className="absolute right-5 top-5 p-3 bg-white/20 backdrop-blur-md rounded-2xl text-white active:scale-95 transition z-20 hover:bg-white/30 flex items-center gap-2"
                            onClick={triggerCamera}
                            disabled={isScanning}
                        >
                             {isScanning ? "..." : <Icon name="Camera" size={24} />}
                             <span className="text-xs font-bold">ç›¸æ©Ÿè¨˜å¸³</span>
                        </button>
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" capture="environment" onChange={handleImageUpload}/>
                    </div>

                    <div className="bg-white p-5 rounded-3xl shadow-lg shadow-indigo-100/50 border border-white space-y-3">
                        <h3 className="font-bold text-slate-700">æ–°å¢æ¶ˆè²»</h3>
                        <div className="space-y-3">
                            <input placeholder="é …ç›® (å¦‚: æ‹‰éºµ)" className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} />
                            <div className="flex gap-3">
                                <input type="number" placeholder="é‡‘é¡" className="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm" value={newAmount} onChange={e => setNewAmount(e.target.value)} />
                                <select className="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm text-slate-600" value={newCat} onChange={e => setNewCat(e.target.value)}>
                                    <option value="food">é¤é£²</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <button onClick={addExpense} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-slate-200 mt-2">æ–°å¢ä¸€ç­†</button>
                    </div>
                    
                    <div className="space-y-3">
                        {expenses.map(ex => (
                            <div key={ex.id} className="flex justify-between items-center bg-white p-4 rounded-2xl border border-white shadow-sm">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-xl ${
                                        ex.cat === 'food' ? 'bg-orange-50 text-orange-500' : 
                                        ex.cat === 'transport' ? 'bg-blue-50 text-blue-500' : 
                                        ex.cat === 'shopping' ? 'bg-pink-50 text-pink-500' : 'bg-slate-50 text-slate-500'
                                    }`}>
                                        <Icon name={ex.cat === 'food' ? 'Utensils' : ex.cat === 'shopping' ? 'ShoppingBag' : ex.cat === 'transport' ? 'Train' : 'CreditCard'} size={20}/>
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-700">{ex.item}</div>
                                        <div className="text-xs text-slate-400 capitalize">{ex.cat === 'food' ? 'é¤é£²' : ex.cat === 'transport' ? 'äº¤é€š' : ex.cat === 'shopping' ? 'è³¼ç‰©' : 'å…¶ä»–'}</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-black text-slate-800">Â¥{ex.amount.toLocaleString()}</span>
                                    <button onClick={() => setExpenses(expenses.filter(e => e.id !== ex.id))} className="text-slate-300 hover:text-red-400 p-2"><Icon name="Trash2" size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ItineraryDay = ({ dayData }) => {
            const [isOpen, setIsOpen] = useState(dayData.day === 1);

            return (
                <div className="bg-white rounded-3xl shadow-lg shadow-indigo-50/50 border border-white overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <div onClick={() => setIsOpen(!isOpen)} className="p-5 flex items-center justify-between cursor-pointer bg-white hover:bg-slate-50 transition">
                        <div className="flex items-center gap-5">
                            <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg shadow-indigo-200">{dayData.day}</div>
                            <div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-0.5">{dayData.date}</div><div className="text-slate-800 font-black text-lg">{dayData.theme}</div></div>
                        </div>
                        <div className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''} text-slate-400`}><Icon name="ChevronDown" size={20} /></div>
                    </div>
                    {isOpen && (
                        <div className="p-5 pt-0 space-y-6 border-t border-slate-50 mt-2">
                            <div className="relative pl-4 pt-4 space-y-6 border-l-2 border-slate-100 ml-2">
                                {dayData.tasks.map((task) => (
                                    <div key={task.id} className="relative pl-6">
                                        <div className={`absolute -left-[29px] top-0 w-3.5 h-3.5 rounded-full border-2 border-white shadow-sm z-10 ${
                                            task.type === 'food' ? 'bg-orange-400' : 
                                            task.type === 'shopping' ? 'bg-pink-400' : 
                                            task.type === 'transport' ? 'bg-blue-400' : 'bg-green-400'
                                        }`}></div>
                                        <div className="flex flex-col gap-1">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <span className="inline-block text-[10px] font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded mb-1">{task.time}</span>
                                                    <div className="font-bold text-slate-800 text-base leading-tight">{task.title}</div>
                                                </div>
                                            </div>
                                            {task.note && <div className="text-xs text-slate-500 bg-slate-50 p-2 rounded-lg border border-slate-100 mt-1">{task.note}</div>}
                                            {task.map && (
                                                <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(task.map)}`} target="_blank" className="inline-flex items-center gap-1 text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg self-start mt-1 hover:bg-blue-100 transition">
                                                    <Icon name="Navigation" size={10} /> å°èˆª
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [itinerary, setItinerary] = useState(initialTripData.itinerary);
            const [checklist, setChecklist] = useState(() => JSON.parse(localStorage.getItem('fukuoka_checklist')) || initialChecklist);
            const [leaderInfo, setLeaderInfo] = useState(() => JSON.parse(localStorage.getItem('fukuoka_leader')) || { name: '', phone: '' });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('fukuoka_api_key') || '');

            useEffect(() => { localStorage.setItem('fukuoka_checklist', JSON.stringify(checklist)); }, [checklist]);
            useEffect(() => { localStorage.setItem('fukuoka_leader', JSON.stringify(leaderInfo)); }, [leaderInfo]);
            useEffect(() => { localStorage.setItem('fukuoka_api_key', apiKey); }, [apiKey]);

            const toggleChecklist = (id) => setChecklist(prev => prev.map(i => i.id === id ? { ...i, done: !i.done } : i));

            return (
                <div className="flex flex-col h-full font-sans text-slate-800 bg-[#FFF7ED]">
                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'home' && <HomeTab leaderInfo={leaderInfo} setLeaderInfo={setLeaderInfo} setActiveTab={setActiveTab} apiKey={apiKey} setApiKey={setApiKey} />}
                        {activeTab === 'itinerary' && (
                            <div className="h-full overflow-y-auto p-5 pb-32 space-y-5">
                                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm">
                                    <p className="text-blue-800 font-bold text-sm">å¥´éš¸å®ˆå‰‡ #1</p>
                                    <p className="text-blue-600 text-xs mt-1">ç³–ç³–è‚šå­é¤“çš„æ™‚å€™è¦ç«‹åˆ»æ‹¿å‡ºé›¶é£Ÿï¼Œé€›è¡—é€›ç´¯äº†è¦ä¸»å‹•æ‰¾æ¤…å­ã€‚</p>
                                </div>
                                {itinerary.map(day => <ItineraryDay key={day.day} dayData={day} />)}
                            </div>
                        )}
                        {activeTab === 'map' && <MapTab itinerary={itinerary} />}
                        {activeTab === 'wallet' && <ExpenseTracker apiKey={apiKey} />}
                        {activeTab === 'tools' && <ToolboxTab checklist={checklist} setChecklist={setChecklist} toggleChecklist={toggleChecklist} />}
                    </div>
                    
                    {/* Bottom Floating Navigation */}
                    <div className="fixed bottom-8 left-6 right-6 bg-white/90 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-2xl shadow-indigo-900/10 px-2 py-2 flex justify-between items-center z-50">
                        {[
                            { id: 'home', icon: 'Home', label: 'é¦–é ' },
                            { id: 'itinerary', icon: 'Calendar', label: 'è¡Œç¨‹' },
                            { id: 'map', icon: 'Map', label: 'åœ°åœ–' },
                            { id: 'wallet', icon: 'CreditCard', label: 'è¨˜å¸³' }, // Renamed from Wallet to è¨˜å¸³ for clarity
                            { id: 'tools', icon: 'Briefcase', label: 'å·¥å…·' }
                        ].map(tab => (
                            <button 
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)} 
                                className={`flex flex-col items-center gap-1 p-2 px-3 rounded-[1.5rem] transition-all duration-300 ${
                                    activeTab === tab.id 
                                        ? 'bg-slate-800 text-white scale-105 shadow-lg' 
                                        : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <Icon name={tab.icon} size={20} className={activeTab === tab.id ? "stroke-[2.5px]" : "stroke-[2px]"}/>
                                {activeTab === tab.id && <span className="text-[10px] font-bold">{tab.label}</span>}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>