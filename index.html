<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>æ—ç³–ç³–çš„å¥´éš¸ï¼šé«˜é›„æ¥µè‡´é¤µé£Ÿè¡Œ ğŸ–</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F97316">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' ry='100' fill='%23F97316'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eé£½%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' ry='100' fill='%23F97316'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eé£½%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href='data:application/manifest+json,{"name":"é«˜é›„é¤µé£Ÿ","short_name":"é«˜é›„é¤µé£Ÿ","display":"standalone","start_url":".","background_color":"#FFF7ED","theme_color":"#F97316","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 rx=%27100%27 ry=%27100%27 fill=%27%23F97316%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27central%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%27300%27 font-family=%27sans-serif%27 font-weight=%27bold%27%3Eé£½%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}'>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #FFF7ED; color: #4B5563; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 0; border: 4px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-pin { display: block !important; width: 16px !important; height: 16px !important; }
        .leaflet-popup-content-wrapper { border-radius: 16px; }
        
        /* æŸ”å’Œæ¼¸å±¤èƒŒæ™¯ */
        .bg-warm { background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%); }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="flex justify-center h-[100dvh] overflow-hidden bg-[#FFF7ED]">

    <div id="root" class="w-full h-full max-w-md bg-[#FFF7ED] shadow-2xl overflow-hidden relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                Image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>,
                Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
                Sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                Navigation: <polygon points="3 11 22 2 13 21 11 13 3 11"/>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Coffee: <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>,
                Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
                Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>,
                Sunrise: <><path d="M12 2v8"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="m8 22 4-10 4 10"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- é«˜é›„ 3å¤©2å¤œ 6é¤/æ—¥ è±ªè¯é¤µé£Ÿç‰ˆ (ä¹ç¦å¤§é£¯åº—) ---
        const initialKaohsiungData = {
          itinerary: [
            {
              day: 1, date: "12/05 (å››)", theme: "ç¾éº—å³¶èˆ‡æ¸¯ç£ ğŸŒŠ",
              tasks: [
                { time: "14:00", title: "é£¯åº— Check-in", type: "stay", map: "é«˜é›„ä¹ç¦å¤§é£¯åº—", lat: 22.6337, lng: 120.3018, note: "ç¾éº—å³¶ç«™æ—ï¼Œæ”¾è¡Œæï¼Œè®“åª½åª½ä¸Šå»æ‰€ä¼‘æ¯ã€‚" },
                { time: "14:30", title: "åˆèŒ¶ï¼šè€æ±Ÿç´…èŒ¶ç‰›å¥¶", type: "tea", map: "è€æ±Ÿç´…èŒ¶ç‰›å¥¶ å—å°é–€å¸‚", lat: 22.6335, lng: 120.3021, note: "å°±åœ¨é£¯åº—éš”å£ï¼ç«è…¿è›‹åå¸+ç´…èŒ¶ç‰›å¥¶æ˜¯ç¶“å…¸ã€‚" },
                { time: "16:00", title: "é§äºŒ & å¤§æ¸¯æ©‹", type: "sightseeing", map: "å¤§æ¸¯æ©‹", lat: 22.6175, lng: 120.2833, note: "æ­æ·é‹è‡³é¹½åŸ•åŸ”ç«™ã€‚å¹³è·¯å¥½èµ°ï¼Œå¹æµ·é¢¨ã€‚" },
                { time: "17:30", title: "é»å¿ƒï¼šé¦™èŒ—èŒ¶è¡Œ", type: "tea", map: "é¦™èŒ—èŒ¶è¡Œ", lat: 22.6245, lng: 120.2845, note: "70å¹´è€å­—è™Ÿï¼å¿…åƒèŒ¶é¦™éœœæ·‡æ·‹èˆ‡é®®å¥¶èŒ¶ã€‚" },
                { time: "18:30", title: "æ™šé¤ï¼šé´¨è‚‰ç", type: "food", map: "é´¨è‚‰ç", lat: 22.6234, lng: 120.2857, note: "é¹½åŸ•å€å¿…åƒï¼ç‰›è‚‰æ‹Œéºµï¼Œç’°å¢ƒæœ‰å†·æ°£ï¼Œé•·è¼©å‹å–„ã€‚" },
                { time: "20:30", title: "å®µå¤œï¼šå…­åˆå¤œå¸‚", type: "food", map: "Liuhe Night Market", lat: 22.6336, lng: 120.3019, note: "å›é£¯åº—æ—é€›é€›ã€‚æ¨è–¦ï¼šé„­è€ç‰Œæœ¨ç“œç‰›å¥¶ã€æµ·ç”¢ç²¥ã€‚" }
              ]
            },
            {
              day: 2, date: "12/06 (äº”)", theme: "è€åº—ç¾é£Ÿå·¡ç¦® ğŸ¥¢",
              tasks: [
                { time: "09:00", title: "æ—©é¤ï¼šèˆˆéš†å±…", type: "food", map: "èˆˆéš†å±…", lat: 22.6274, lng: 120.2953, note: "æ­æ·é‹è‡³å¸‚è­°æœƒç«™ã€‚å¿…åƒçˆ†æ±æ¹¯åŒ…ã€ç‡’é¤…ã€‚" },
                { time: "10:30", title: "æ—©èŒ¶ï¼šé«˜é›„å©†å©†å†°", type: "tea", map: "é«˜é›„å©†å©†å†°å‰µå§‹åº—", lat: 22.6268, lng: 120.2838, note: "é¹½åŸ•å€ï¼Œåƒå€‹å¤æ—©å‘³ç•ªèŒ„åˆ‡ç›¤æˆ–èŠ’æœå†°ã€‚" },
                { time: "12:30", title: "åˆé¤ï¼šåšå¾—ç¦", type: "food", map: "åšå¾—ç¦æ¹¯åŒ…éºµé£Ÿå°ˆè³£åº—", lat: 22.6165, lng: 120.2973, note: "ç’°å¢ƒä¹¾æ·¨èˆ’æœï¼Œåƒé¼æ³°è±ä½†æ›´åœ¨åœ°ã€‚ç´…æ²¹æŠ„æ‰‹ã€é£›é¤…ã€‚" },
                { time: "14:30", title: "åˆèŒ¶ï¼šæ£§è²³åº«æµ·æ™¯", type: "tea", map: "KW2 æ£§è²³åº«", lat: 22.6155, lng: 120.2785, note: "åœ¨å®¤å…§å¹å†·æ°£çœ‹æµ·ï¼Œæœ‰å¾ˆå¤šæ–‡å‰µå°åº—ã€‚" },
                { time: "17:00", title: "è¼•è»ŒéŠæ„›æ²³ç£", type: "sightseeing", map: "Glory Pier", lat: 22.6174, lng: 120.2924, note: "æ­è¼•è»Œçœ‹æµè¡ŒéŸ³æ¨‚ä¸­å¿ƒï¼Œä¸ç”¨èµ°è·¯ã€‚" },
                { time: "18:30", title: "æ™šé¤ï¼šæ±•é ­æ³‰æˆæ²™èŒ¶ç«é‹", type: "food", map: "æ±•é ­æ³‰æˆæ²™èŒ¶ç«é‹ ä¸­å±±ç¸½åº—", lat: 22.6314, lng: 120.3022, note: "ç¾éº—å³¶ç«™æ—ã€‚ç™¾å¹´è€åº—ï¼Œæ‰é­šæ¹¯é ­è¶…è®šã€‚" },
                { time: "21:00", title: "å®µå¤œï¼šé£¯åº—æ°´æœ/é»å¿ƒ", type: "food", note: "å¯ä»¥åœ¨é™„è¿‘çš„è¶…å•†è²·é»å„ªæ ¼æˆ–æ°´æœã€‚" }
              ]
            },
            {
              day: 3, date: "12/07 (å…­)", theme: "çœ·æ‘èˆ‡è³¦æ­¸ ğŸš„",
              tasks: [
                { time: "09:30", title: "æ—©é¤ï¼šä¸¹ä¸¹æ¼¢å ¡", type: "food", map: "ä¸¹ä¸¹æ¼¢å ¡ ä¸ƒè³¢åº—", lat: 22.6354, lng: 120.2953, note: "å—éœ¸å¤©ï¼ä¸ƒè³¢åº—é›¢é£¯åº—ä¸é ã€‚éºµç·šç¾¹+ç‚¸é›ã€‚" },
                { time: "11:00", title: "æ—©èŒ¶ï¼šå³å¯¶æ˜¥éº¥æ–¹åº—", type: "tea", map: "å³å¯¶æ˜¥éº¥æ–¹åº— é«˜é›„æ——è‰¦åº—", lat: 22.6204, lng: 120.3106, note: "å»å¸‚æ”¿åºœç«™è²·ä¸–ç•Œå† è»éºµåŒ…ç•¶ä¼´æ‰‹ç¦®ã€‚" },
                { time: "12:30", title: "åˆé¤ï¼šä¸‰ç‰›ç‰›è‚‰éºµ", type: "food", map: "ä¸‰ç‰›ç‰›è‚‰éºµ", lat: 22.6803, lng: 120.2975, note: "è“®æ± æ½­æ—ã€‚ä»½é‡å¤§ï¼Œå°èœå¤šã€‚åƒå®Œå¯ç¨å¾®æ•£æ­¥é¾è™å¡”ã€‚" },
                { time: "14:00", title: "æ•£æ­¥ï¼šè“®æ± æ½­é¾è™å¡”", type: "sightseeing", map: "Dragon and Tiger Pagodas", lat: 22.6791, lng: 120.2911, note: "æ¶ˆç½è§£å„ï¼Œæ‹å¼µç…§ç•™å¿µã€‚" },
                { time: "15:00", title: "åˆèŒ¶ï¼šæ¨ºé”å¥¶èŒ¶", type: "tea", map: "æ¨ºé”å¥¶èŒ¶ å·¦ç‡Ÿé«˜éµåº—", lat: 22.6882, lng: 120.3089, note: "å»é«˜éµç«™è²·ç¸½åº—èµ·å®¶çš„å¥¶èŒ¶ã€‚" },
                { time: "16:00", title: "å¿«æ¨‚è³¦æ­¸", type: "transport", map: "Zuoying Station", lat: 22.6882, lng: 120.3089, note: "æ­ä¹˜é«˜éµå›å®¶ï¼Œæ™šé¤åƒé«˜éµä¾¿ç•¶ã€‚" }
              ]
            }
          ]
        };

        // --- COMPONENTS ---

        const MapTab = ({ itinerary }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const [status, setStatus] = useState("å®šä½ä¸­...");

            useEffect(() => {
                if (!mapInstanceRef.current && mapContainerRef.current) {
                    mapInstanceRef.current = L.map(mapContainerRef.current).setView([22.6337, 120.3018], 14); // Center on Hotel
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Map data &copy; OpenStreetMap'
                    }).addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;
                
                // Add Itinerary Markers
                itinerary.forEach(day => {
                    day.tasks.forEach(task => {
                        if (task.lat && task.lng) {
                            let color = '#22C55E'; // green default
                            if (task.type === 'food') color = '#F97316'; // orange dinner/lunch
                            if (task.type === 'tea') color = '#EAB308'; // yellow tea/snack
                            if (task.type === 'sightseeing') color = '#3B82F6'; // blue
                            if (task.type === 'stay') color = '#EC4899'; // pink
                            
                            const markerHtml = `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                            const icon = L.divIcon({className: 'custom-pin', html: markerHtml, iconSize: [16, 16], popupAnchor: [0, -10]});
                            
                            const marker = L.marker([task.lat, task.lng], { icon }).addTo(map);
                            marker.bindTooltip(task.title, { permanent: false, direction: 'top', offset: [0, -12] });
                            marker.bindPopup(`
                                <div style="text-align:center">
                                    <div style="font-weight:bold; margin-bottom:5px; color:#333;">${task.title}</div>
                                    <div style="font-size:12px; color:#666;">${task.note}</div>
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(task.map || task.title)}" target="_blank" style="display:inline-block; margin-top:8px; color:white; background:#3B82F6; padding:4px 12px; border-radius:15px; text-decoration:none; font-size:12px; font-weight:bold;">Google å°èˆª</a>
                                </div>
                            `);
                        }
                    });
                });

                // User Location
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        setStatus("å®šä½æˆåŠŸ");
                        if (map) {
                            if (!userMarkerRef.current) {
                                const userIcon = L.divIcon({
                                    className: 'user-pin',
                                    html: "<div style='background-color:#2563EB; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow: 0 0 0 6px rgba(59,130,246,0.3);'></div>",
                                    iconSize: [20, 20]
                                });
                                userMarkerRef.current = L.marker([latitude, longitude], {icon: userIcon, zIndexOffset: 1000}).addTo(map);
                            } else {
                                userMarkerRef.current.setLatLng([latitude, longitude]);
                            }
                        }
                    }, (err) => setStatus("è«‹é–‹å•ŸGPSä»¥å®šä½"), {enableHighAccuracy: true});
                }
            }, [itinerary]);

            return (
                <div className="h-full relative">
                    <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[400] bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg text-xs font-bold text-slate-600 border border-slate-100 flex gap-2 items-center whitespace-nowrap">
                        <span>{status}</span>
                        <span className="text-[10px] text-slate-400">| æ©˜:æ­£é¤ é»ƒ:é»å¿ƒ è—:ç©</span>
                    </div>
                    <div id="map" ref={mapContainerRef} className="w-full h-full"></div>
                </div>
            );
        };

        // Photo Journal Component
        const PhotoJournal = () => {
            const [photos, setPhotos] = useState(() => JSON.parse(localStorage.getItem('kh_photos')) || []);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('kh_photos', JSON.stringify(photos)); }, [photos]);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const newPhoto = {
                            id: Date.now(),
                            url: reader.result,
                            caption: "",
                            date: new Date().toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})
                        };
                        setPhotos([newPhoto, ...photos]);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const updateCaption = (id, txt) => {
                setPhotos(prev => prev.map(p => p.id === id ? { ...p, caption: txt } : p));
            };

            const deletePhoto = (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) setPhotos(prev => prev.filter(p => p.id !== id));
            };

            return (
                <div className="h-full overflow-y-auto p-5 pb-32 bg-[#FFF7ED]">
                    <div className="bg-orange-100 rounded-3xl p-6 mb-6 text-center shadow-inner border border-orange-200">
                        <h2 className="text-2xl font-bold text-orange-800 mb-2">ğŸ“¸ åª½åª½åƒè²¨æ—¥è¨˜</h2>
                        <p className="text-orange-600 text-sm mb-4">è¨˜éŒ„æ¯ä¸€é¤é–‹å¿ƒçš„æ¨£å­ï¼</p>
                        
                        <label className="bg-white text-orange-500 px-6 py-3 rounded-full font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mx-auto cursor-pointer w-fit">
                            <Icon name="Camera" size={20}/> æ–°å¢ç…§ç‰‡
                            <input type="file" className="hidden" accept="image/*" onChange={handleFile} />
                        </label>
                    </div>

                    <div className="space-y-6">
                        {photos.length === 0 && <div className="text-center text-slate-400 py-10">ç›®å‰æ˜¯ç©ºçš„ï¼Œå¿«å»æ‹ç…§å§ï¼</div>}
                        {photos.map(photo => (
                            <div key={photo.id} className="bg-white p-3 rounded-2xl shadow-md border border-white rotate-1 hover:rotate-0 transition duration-300 animate-bounce-in">
                                <img src={photo.url} alt="memory" className="w-full h-56 object-cover rounded-xl bg-slate-100 mb-3"/>
                                <div className="flex gap-2 items-end">
                                    <div className="flex-1">
                                        <input 
                                            placeholder="å¯«ä¸‹é€™åˆ»çš„å¿ƒæƒ…..." 
                                            className="w-full text-sm p-2 bg-slate-50 rounded-lg border-none focus:ring-2 focus:ring-orange-200"
                                            value={photo.caption}
                                            onChange={(e) => updateCaption(photo.id, e.target.value)}
                                        />
                                        <div className="text-[10px] text-slate-400 mt-1 ml-1">{photo.date}</div>
                                    </div>
                                    <button onClick={() => deletePhoto(photo.id)} className="text-slate-300 hover:text-red-400 p-2"><Icon name="Trash2" size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ItineraryTab = ({ itinerary }) => {
            const [activeDay, setActiveDay] = useState(1);

            return (
                <div className="h-full overflow-y-auto p-5 pb-32 bg-[#FFF7ED]">
                    <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                        {[1,2,3].map(d => (
                            <button 
                                key={d}
                                onClick={() => setActiveDay(d)}
                                className={`px-5 py-2 rounded-full font-bold text-sm whitespace-nowrap transition ${activeDay === d ? 'bg-orange-500 text-white shadow-lg shadow-orange-200' : 'bg-white text-slate-400'}`}
                            >
                                Day {d}
                            </button>
                        ))}
                    </div>

                    <div className="space-y-4">
                        {itinerary.find(d => d.day === activeDay).tasks.map(task => (
                            <div key={task.id} className="bg-white p-4 rounded-2xl shadow-sm border border-white flex gap-4 items-start hover:shadow-md transition">
                                <div className={`mt-1 w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${
                                    task.type === 'food' ? 'bg-orange-100 text-orange-500' :
                                    task.type === 'tea' ? 'bg-yellow-100 text-yellow-600' :
                                    task.type === 'sightseeing' ? 'bg-blue-100 text-blue-500' : 
                                    task.type === 'stay' ? 'bg-pink-100 text-pink-500' : 'bg-green-100 text-green-500'
                                }`}>
                                    <Icon name={task.type === 'food' ? 'Utensils' : task.type === 'tea' ? 'Coffee' : task.type === 'sightseeing' ? 'Map' : task.type === 'stay' ? 'Home' : 'Train'} size={20}/>
                                </div>
                                <div className="flex-1">
                                    <div className="flex justify-between mb-1">
                                        <div className="font-black text-slate-800 text-lg">{task.title}</div>
                                        <span className="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg h-fit whitespace-nowrap">{task.time}</span>
                                    </div>
                                    <div className="text-sm text-slate-500 mb-2">{task.note}</div>
                                    {task.map && (
                                        <a href={`https://www.google.com/maps/search/?api=1&query=${task.map}`} target="_blank" className="inline-flex items-center gap-1 text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition">
                                            <Icon name="Navigation" size={12}/> å°èˆªå»
                                        </a>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Map Modal Component
        const MapModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[999] bg-black/80 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl overflow-hidden w-full max-w-lg relative" onClick={e => e.stopPropagation()}>
                        <div className="p-3 bg-slate-100 flex justify-between items-center border-b">
                            <h3 className="font-bold text-slate-700">é«˜é›„æ·é‹ & è¼•è»Œè·¯ç¶²åœ–</h3>
                            <button onClick={onClose} className="p-2 text-slate-500 hover:bg-slate-200 rounded-full"><Icon name="X" size={20} /></button>
                        </div>
                        <div className="p-0 overflow-auto max-h-[70vh] bg-white flex justify-center">
                            {/* Using a reliable Wikimedia source for the map image */}
                            <img 
                                src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Kaohsiung_MRT_%26_LRT_system_map_TR.svg/1024px-Kaohsiung_MRT_%26_LRT_system_map_TR.svg.png" 
                                alt="Kaohsiung MRT Map" 
                                className="w-full h-auto object-contain"
                            />
                        </div>
                        <div className="p-3 bg-slate-50 border-t flex justify-center">
                            <a href="https://www.krtc.com.tw/Guide/routemap" target="_blank" className="text-xs font-bold text-blue-500 flex items-center gap-1">
                                å‰å¾€å®˜ç¶²æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ <Icon name="ExternalLink" size={12}/>
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const HomeTab = ({ setActiveTab, itinerary }) => {
            const [showMapModal, setShowMapModal] = useState(false);

            // Smart Suggest Logic
            const findNearest = () => {
                if (!navigator.geolocation) return alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œè«‹æ‰‹å‹•æŸ¥çœ‹è¡Œç¨‹");
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    let minDis = Infinity;
                    let nearest = null;
                    
                    itinerary.forEach(day => {
                        day.tasks.forEach(task => {
                            if(task.lat && (task.type === 'food' || task.type === 'tea')) {
                                const dis = Math.sqrt(Math.pow(task.lat - latitude, 2) + Math.pow(task.lng - longitude, 2));
                                if(dis < minDis) {
                                    minDis = dis;
                                    nearest = task;
                                }
                            }
                        });
                    });

                    if(nearest) {
                        if(confirm(`ğŸ’¡ è‚šå­é¤“äº†å—ï¼Ÿ\n\nè·é›¢æœ€è¿‘çš„è¡¨å®šç¾é£Ÿæ˜¯ï¼š\nã€Œ${nearest.title}ã€\n\nè¦å°èˆªéå»å—ï¼Ÿ`)) {
                            window.open(`https://www.google.com/maps/search/?api=1&query=${nearest.map || nearest.title}`, '_blank');
                        }
                    }
                }, (err) => alert("ç„¡æ³•å–å¾—å®šä½"));
            };

            return (
                <div className="h-full overflow-y-auto pb-24 bg-[#FFF7ED]">
                    <div className="bg-gradient-to-br from-orange-400 to-pink-400 text-white p-8 rounded-b-[3rem] shadow-xl relative overflow-hidden mb-6">
                        <div className="absolute top-0 right-0 w-40 h-40 bg-white/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <h1 className="text-3xl font-black mb-2 tracking-tight">é«˜é›„è¦ªå­æ¼«éŠ â˜€ï¸</h1>
                        <p className="text-white/90 font-medium">å¸¶åª½åª½åƒå–ç©æ¨‚ Day 1-3</p>
                        <div className="mt-6 flex gap-3">
                            <button onClick={findNearest} className="flex-1 bg-white/20 backdrop-blur border border-white/40 py-3 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-white/30 transition shadow-sm">
                                <Icon name="Search" size={16}/> æˆ‘ç¾åœ¨å»å“ªåƒ?
                            </button>
                        </div>
                    </div>

                    <div className="px-5 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => setActiveTab('itinerary')} className="bg-white p-5 rounded-3xl shadow-sm border border-white flex flex-col items-center gap-2 hover:scale-105 transition">
                                <div className="w-12 h-12 bg-orange-100 text-orange-500 rounded-2xl flex items-center justify-center"><Icon name="Calendar" size={24}/></div>
                                <span className="font-bold text-slate-600">è¡Œç¨‹è¡¨</span>
                            </button>
                            <button onClick={() => setActiveTab('map')} className="bg-white p-5 rounded-3xl shadow-sm border border-white flex flex-col items-center gap-2 hover:scale-105 transition">
                                <div className="w-12 h-12 bg-blue-100 text-blue-500 rounded-2xl flex items-center justify-center"><Icon name="Map" size={24}/></div>
                                <span className="font-bold text-slate-600">åœ°åœ–</span>
                            </button>
                        </div>

                        <div className="bg-white p-5 rounded-3xl shadow-sm border border-white">
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Icon name="Sun" size={20} className="text-yellow-500"/> å¯¦ç”¨é€£çµ</h3>
                            <div className="space-y-3">
                                {/* Fixed: Opens modal instead of direct link */}
                                <button onClick={() => setShowMapModal(true)} className="w-full block bg-slate-50 p-3 rounded-xl text-sm font-bold text-slate-600 flex justify-between items-center hover:bg-slate-100 transition text-left">
                                    <span>ğŸš„ é«˜é›„æ·é‹/è¼•è»Œåœ–</span>
                                    <span className="text-orange-400 text-xl">â€º</span>
                                </button>
                                <a href="https://www.google.com/maps/search/é«˜é›„ç¾é£Ÿ" target="_blank" className="block bg-slate-50 p-3 rounded-xl text-sm font-bold text-slate-600 flex justify-between items-center hover:bg-slate-100 transition">
                                    <span>ğŸœ é™„è¿‘ç¾é£Ÿæœå°‹</span>
                                    <span className="text-orange-400 text-xl">â€º</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <MapModal isOpen={showMapModal} onClose={() => setShowMapModal(false)} />
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const itinerary = initialKaohsiungData.itinerary;

            return (
                <div className="flex flex-col h-full font-sans text-slate-800 bg-[#FFF7ED]">
                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'home' && <HomeTab setActiveTab={setActiveTab} itinerary={itinerary} />}
                        {activeTab === 'itinerary' && <ItineraryTab itinerary={itinerary} />}
                        {activeTab === 'map' && <MapTab itinerary={itinerary} />}
                        {activeTab === 'photo' && <PhotoJournal />}
                    </div>
                    
                    <div className="fixed bottom-8 left-6 right-6 bg-white/90 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-2xl shadow-orange-900/10 px-4 py-3 flex justify-between items-center z-50">
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 transition ${activeTab === 'home' ? 'text-orange-500 scale-110' : 'text-slate-400'}`}><Icon name="Home" size={24}/></button>
                        <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 transition ${activeTab === 'itinerary' ? 'text-orange-500 scale-110' : 'text-slate-400'}`}><Icon name="Calendar" size={24}/></button>
                        <button onClick={() => setActiveTab('photo')} className={`flex flex-col items-center gap-1 transition ${activeTab === 'photo' ? 'text-orange-500 scale-110' : 'text-slate-400'}`}><Icon name="Image" size={24}/></button>
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center gap-1 transition ${activeTab === 'map' ? 'text-orange-500 scale-110' : 'text-slate-400'}`}><Icon name="Map" size={24}/></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>